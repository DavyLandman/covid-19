---
pagetitle: Daily Municipality Update
output: html_document
runtime: shiny
css: daily_municipality.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(data.table)
require(xtable)

setwd('../')

dat.totals.color <- read.csv("data/municipality-totals-color.csv")
dat.totals.growth <- read.csv("data/municipality-totals-growth.csv")
dat.today.wide <- read.csv("data/municipality-today-detailed.csv") %>%
  arrange(municipality)
used_date <- as.Date(last(dat.today.wide$date))

str.none <- '<span class="none">&nbsp;-&nbsp;</span>'

print_municipality_data <- function(data, cssClass = "") {
  data.printable <- transmute(data,
    increase_1d = ifelse( increase_1d == 0, str.none, sprintf("%+d", increase_1d)),
    color = color_incl_new,
    municipality = sprintf('<span class="municipality">%s</span><hr/>', municipality),
    current = ifelse( current == 0, str.none, sprintf("%d", current)),
    increase_7d = ifelse( increase_7d == 0, str.none, sprintf("( *w: %+d * )", increase_7d)),
    growth = ifelse( growth == "-", str.none, growth)
  )

  table <- xtable(data.printable, auto = TRUE)
  align(table) <- "ccllrll"

  print( table, 
    type = "html", 
    sanitize.text.function=function(x){x},
    html.table.attributes = paste('border=0', ifelse( cssClass == "", "", paste( 'class="',  cssClass, '"', sep =  "")), sep = " "), 
    include.colnames = FALSE, 
    include.rownames = FALSE
  )
  rm(data.printable, table)
}

```

### Legenda
‚úÖ geen geconstateerde besmettingen  
üí• nieuwe besmettingen in een groene gemeente  
üü°  < 5 / 100.000 inwoners / 7 dagen  
üüß  < 50 / 100.000 inwoners / 7 dagen  
üõë  >= 50 / 100.000 inwoners / 7 dagen  

‚¨ÜÔ∏è ‚¨ÜÔ∏è Fors stijgende trend ( > 100% )  
‚¨ÜÔ∏è Stijgende trend ( 0 - 100% )  
‚¨áÔ∏è Dalende trend   

Bovenstaande zijn berekend op laatste  
7 dagen t.o.v. de 7 dagen daarvoor  

### Voorbeeld:
```{r echo = FALSE, results = "asis"}
dat.example <- dat.today.wide %>%
  filter( municipality == "Montfoort" )

print_municipality_data(dat.example, "example")

template.example <- "
%+d sinds gisteren   
%+d sinds 1 juli   
%+d sinds 7 dagen ( %s )   
Wat meer is dan de %+d in de 7 dagen ervoor   
%s inwoners maakt dat	%s %.1f / 100.000 / 7d
"

example <- first(dat.example)
cat(sprintf(template.example, 
  example$increase_1d, 
  example$current, 
  example$increase_7d, 
  format(used_date - 7, '%d-%m-%Y'), 
  example$d7 - example$d14, 
  formatC(example$population, format="f", big.mark=".", decimal.mark=",", digits=0),
  example$color, 
  example$rel_increase_7d, 
  0
))
```

### Landelijk:
19.301 üüß totaal sinds 1 juli (+501) ( w: +3.535 ‚¨áÔ∏è )   
142 / 355 gemeentes met nieuwe besmettingen (w: 299 )   
116 	Gemeente Onbekend (+2)   

#### Alert niveaus
```{r echo = FALSE, results = "asis"}

template <- "%d / %d gemeentes ( %+d ) ( *w: %+d* )"
dat.totals.color.printable <- transmute(dat.totals.color,
  color = color,
  text = sprintf(template, d0, 355, increase_1d, increase_7d)
)

table <- xtable(dat.totals.color.printable, auto = TRUE)
align(table) <- "lll"

print( table, 
  type = "html", 
  html.table.attributes = 'border=0', 
  include.colnames = FALSE, 
  include.rownames = FALSE
)
rm(template, table, dat.totals.color.printable)
```

#### Groei
```{r echo = FALSE, results = "asis"}

template <- "%d / %d gemeentes"
dat.totals.growth.printable <- transmute(dat.totals.growth,
  growth = ifelse( growth == "-", str.none, growth),
  text = sprintf(template, d0, 355)
)

table <- xtable(dat.totals.growth.printable, auto = TRUE)
align(table) <- "lll"

print( table, 
  type = "html", 
  html.table.attributes = 'border=0', 
  sanitize.text.function=function(x){x},
  include.colnames = FALSE, 
  include.rownames = FALSE
)
rm(template, table, dat.totals.growth.printable)

```

### Hoogste toenames van vandaag:
```{r echo = FALSE, results = "asis"}
dat.today.highest <- dat.today.wide %>%
  filter( increase_1d > 1 | (increase_1d == 1 & color_incl_new %in% c("üõë", "üí•")) ) %>%
  arrange(desc(increase_1d), current)

print_municipality_data(dat.today.highest)

```
### Alle gemeentes

```{r echo = FALSE, results = "asis"}

print_municipality_data(dat.today.wide)

```
