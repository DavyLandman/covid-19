---
pagetitle: Daily Municipality Update
output:
  html_document:
    theme: null
    highlight: null
    mathjax: null
    self_contained: false
    css: ['https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css', 'daily_municipality.css']
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(data.table)
require(xtable)
require(shiny)

const.toplist_minimum = 20

setwd('../')

dat.totals.color <- read.csv("data/municipality-totals-color.csv", fileEncoding = "UTF-8")
dat.totals.growth <- read.csv("data/municipality-totals-growth.csv", fileEncoding = "UTF-8")
dat.cases <- read.csv("data/municipality-today-detailed.csv", fileEncoding = "UTF-8") %>%
  arrange(municipality)
dat.hosp <- read.csv("data/municipality-hospitalisations-today-detailed.csv", fileEncoding = "UTF-8") %>%
  arrange(municipality)
dat.deaths <- read.csv("data/municipality-deaths-today-detailed.csv", fileEncoding = "UTF-8") %>%
  arrange(municipality)
used_date <- as.Date(last(dat.cases$date))

str.none <- '<span class="none">&nbsp;-&nbsp;</span>'

format_custom_number <- function(data, plus = FALSE, format = "%s") {
  return( sapply(data, function(value){
    formatted_value <- formatC(value, format="f", big.mark=".", decimal.mark=",", digits=0)
    plus_or_minus <- ifelse(value > 0, '+', '-')
    formatted_value <- ifelse(plus, paste( plus_or_minus, formatted_value, sep = ''), formatted_value)
    formatted_value <- sprintf(format, formatted_value)
    formatted_value <- ifelse(value == 0, str.none, formatted_value)
    return(formatted_value)
  }))
}

print_table <- function(data, alignment, cssClass = "") {
  table <- xtable(data, auto = TRUE)
  align(table) <- alignment
  
  print( table, 
    type = "html", 
    sanitize.text.function=function(x){x},
    html.table.attributes = paste('border=0', ifelse( cssClass == "", "", paste( 'class="',  cssClass, '"', sep =  "")), sep = " "), 
    include.colnames = FALSE, 
    include.rownames = FALSE
  )
}

print_municipality_data <- function(data, cssClass = "", include_color = TRUE, two_weeks = FALSE) {
  if (!include_color) {
    data <- mutate( data, color_incl_new = '') 
  }
  
  data.printable <- transmute(data,
    increase_1d = format_custom_number(increase_1d, TRUE),
    color = color_incl_new,
    municipality = sprintf('<span class="municipality">%s</span><hr/>', municipality),
    current = format_custom_number(current),
    increase_7d = format_custom_number(increase_7d, TRUE, "( *w: %s * )"),
    increase_14d = format_custom_number(increase_14d, TRUE, "( *2w: %s * )"),
    growth = ifelse( growth == "-", str.none, growth)
  )
  
  if (two_weeks){
    data.printable <- subset(data.printable, select = -c(increase_7d))
  } else {
    data.printable <- subset(data.printable, select = -c(increase_14d))
  }
  
  alignment <- "ccllrll"
  
  if (!include_color) {
    alignment <- "cclrll"
    data.printable <- subset(data.printable, select = -c(color))
  }
  
  print_table(data.printable, alignment, cssClass)
}

print_detailed <- function(data){
  template.example <- "
  %s sinds gisteren   
  %s sinds 1 september   
  %s sinds 7 dagen ( %s )   
  Wat %s is dan de %s in de 7 dagen ervoor   
  %s inwoners maakt dat %s %.1f / 100.000 / 7d
  "
  
  print_municipality_data(data, "example align-left")
  
  data <- first(data)
  more_or_less <- (data$d0 - data$d7) / (data$d7 - data$d14)
  cat(sprintf(template.example, 
    ifelse(data$increase_1d == 0, 0, format_custom_number(data$increase_1d, TRUE)),
    format_custom_number(data$current, TRUE),
    format_custom_number(data$increase_7d, TRUE),
    format(used_date - 7, '%d-%m-%Y'), 
    ifelse(   more_or_less >= 2, "fors meer", 
      ifelse( more_or_less >= 1, "meer",  
      ifelse( more_or_less < 0.4, "fors minder", 
                                  "minder" 
    ))),
    format_custom_number(data$d7 - data$d14, TRUE),
    format_custom_number(data$population),
    data$color, 
    data$rel_increase_7d, 
    0
  ))
}
```

```{r echo=FALSE}
knitr::asis_output(htmltools::htmlPreserve("
<section class='cases'>
  <header>
"))

```

# Geconstateerde Besmettingen
### Legenda
‚úÖ   geen geconstateerde besmettingen  in 7 dagen   
üí•   nieuwe besmettingen in een groene gemeente  
üü°   Gerustellend ( 1-5 / 100.000 inwoners / 7 dagen )  
üüß   Waakzaam ( 5-50 / 100.000 inwoners / 7 dagen )   
üõë   Zorgelijk ( 50-150 / 100.000 inwoners / 7 dagen )  
üü£   Ernstig ( >= 150 / 100.000 inwoners / 7 dagen )

‚¨Ü‚¨Ü Fors stijgende trend ( > 100% )  
‚¨Ü Stijgende trend ( 0 - 100% )  
‚¨á Dalende trend   

Bovenstaande zijn berekend op laatste  
7 dagen t.o.v. de 7 dagen daarvoor  

### Landelijk:
```{r echo = FALSE, results = "asis"}

# +527	üüß	Nederland	20.332	( w: +3.539 )	‚¨áÔ∏è
dat.total <- dat.cases %>%
  filter( municipality == "Netherlands" )
dat.total[dat.total$municipality=="Netherlands", "municipality"] <- "Nederland"

print_detailed(dat.total)
rm(dat.total)

# 142 / 355 gemeentes met nieuwe besmettingen (w: 299 )
# 127 Gemeente Onbekend (+2)

int.count.municipality.today <- dat.cases %>%
  filter(Municipality_code != "" & increase_1d > 0) %>%
  nrow()

int.count.municipality.week <- dat.cases %>%
  filter(Municipality_code != "" & increase_7d > 0) %>%
  nrow()

dat.unknown <- dat.cases %>%
  filter( municipality == "Unknown" )
unknown <- first(dat.unknown)

cat(sprintf("

%s / 355 gemeentes met nieuwe besmettingen (w: %s )   
%s Gemeente Onbekend (%s)",
  format_custom_number(int.count.municipality.today),
  format_custom_number(int.count.municipality.week),
  format_custom_number(unknown$current),
  format_custom_number(unknown$increase_1d, TRUE)
))

rm(int.count.municipality.today, int.count.municipality.week, dat.unknown, unknown)
```

#### Alert niveaus
```{r echo = FALSE, results = "asis"}

template <- "%d / %d gemeentes (%s) ( *w: %s* )"
dat.totals.color.printable <- transmute(dat.totals.color,
  color = color,
  text = sprintf(template, 
    d0, 
    355, 
    ifelse(increase_1d == 0, str.none, sprintf(" %+d ", increase_1d)), 
    ifelse(increase_7d == 0, str.none, sprintf(" %+d ", increase_7d))
  )
)

print_table(dat.totals.color.printable, "lll")

rm(template, dat.totals.color.printable)
```

#### Groei
```{r echo = FALSE, results = "asis"}

template <- "%d / %d gemeentes"
dat.totals.growth.printable <- transmute(dat.totals.growth,
  growth = ifelse( growth == "-", str.none, growth),
  text = sprintf(template, d0, 355)
)

print_table(dat.totals.growth.printable, "lll")

rm(template, dat.totals.growth.printable)

```

#### Hoogste daling van laatste 7 dagen
```{r echo = FALSE, results = "asis"}
dat.success <- dat.cases %>%
  filter( population > 25000 ) %>%
  arrange(increase_growth, desc(current)) %>%
  head(1)

print_detailed(dat.success)
rm(dat.success)
```

#### Hoogste stijging per inwoner van vandaag
```{r echo = FALSE, results = "asis"}
dat.example <- dat.cases %>%
  filter( population > 25000 ) %>%
  arrange(desc(rel_increase_1d), current) %>%
  head(1)

print_detailed(dat.example)
rm(dat.example)
```

#### Hoogste besmettingsgraad
```{r echo = FALSE, results = "asis"}
dat.cases.today.top10 <- dat.cases %>%
  arrange(desc(rel_increase_7d), current) %>%
  head(20) %>%
  transmute(
    color = color_incl_new,
    municipality = sprintf('<span class="municipality">%s</span><hr/>', municipality),
    rel_increase_7d = format_custom_number(rel_increase_7d),
    per = "/ 100.000 / 7d",
    growth = ifelse( growth == "-", str.none, growth)
  )

print_table(dat.cases.today.top10, "cclrll", "")
```

#### Hoogste absolute toenames van vandaag
```{r echo = FALSE, results = "asis"}
dat.cases.today.highest <- dat.cases %>%
  filter( 
    Municipality_code != ""
      & (increase_1d >= const.toplist_minimum
         | (increase_1d > 0 & increase_1d < const.toplist_minimum & color_incl_new %in% c("üí•"))
      )
  ) %>%
  arrange(desc(increase_1d), current)

print_municipality_data(dat.cases.today.highest)
```



```{r echo=FALSE}
knitr::asis_output(htmltools::htmlPreserve("
  </header>
"))

```

### Alle gemeentes

```{r echo = FALSE, results = "asis"}

dat.cases.today.all <- dat.cases %>%
  filter(Municipality_code != "")

print_municipality_data(dat.cases.today.all)
```

```{r echo=FALSE}
knitr::asis_output(htmltools::htmlPreserve("
</section>
<section class='hosp'>
  <header>
"))

```

# Opnames

### Landelijk:
```{r echo = FALSE, results = "asis"}
# 274	COVID-19 opnames (+5) ( w: +44 ‚¨áÔ∏è )

dat.total <- dat.hosp %>%
  filter( municipality == "Netherlands" )
dat.total[dat.total$municipality=="Netherlands", "municipality"] <- "COVID-19 opnames"

print_municipality_data(dat.total, 'align-left', FALSE, TRUE)

rm(dat.total)
```

```{r echo = FALSE, results = "asis"}
int.count.municipality.today <- dat.hosp %>%
  filter(Municipality_code != "" & increase_1d > 0) %>%
  nrow()

int.count.municipality.week <- dat.hosp %>%
  filter(Municipality_code != "" & increase_7d > 0) %>%
  nrow()

dat.unknown <- dat.hosp %>%
  filter( municipality == "Unknown" )
unknown <- first(dat.unknown)

cat(sprintf("
%s / 355 gemeentes met nieuwe meldingen (w: %s )   
%s Gemeente Onbekend (%s)",
  format_custom_number(int.count.municipality.today),
  format_custom_number(int.count.municipality.week),
  format_custom_number(unknown$current),
  format_custom_number(unknown$increase_1d, TRUE)
))

rm(int.count.municipality.today, int.count.municipality.week, dat.unknown, unknown)
```

#### Hoogste aantal opnames per inwoner
```{r echo = FALSE, results = "asis"}
dat.hosp.today.top10 <- dat.hosp %>%
  arrange(desc(rel_increase_14d), current) %>%
  filter(increase_14d >= 3) %>%
  head(20) %>%
  transmute(
    municipality = sprintf('<span class="municipality">%s</span><hr/>', municipality),
    rel_increase_14d = format_custom_number(rel_increase_14d),
    per = "/ 100.000 / 14d"
  )

print_table(dat.hosp.today.top10, "llrl", "")
```

#### Absolute toenames van vandaag
```{r echo = FALSE, results = "asis"}
dat.hosp.today.highest <- dat.hosp %>%
  filter( 
    Municipality_code != "" & increase_1d != 0
  ) %>%
  arrange(desc(increase_1d), current)

print_municipality_data(dat.hosp.today.highest, "", FALSE, TRUE)

```

```{r echo=FALSE}
knitr::asis_output(htmltools::htmlPreserve("
  </header>
"))

```

### Alle gemeentes
```{r echo = FALSE, results = "asis"}

dat.hosp.today.all <- dat.hosp %>%
  filter(Municipality_code != "")

print_municipality_data(dat.hosp.today.all, "", FALSE, TRUE)

```

```{r echo=FALSE}
knitr::asis_output(htmltools::htmlPreserve("
</section>
<section class='deaths'>
  <header>
"))

```

# Overlijdens

### Landelijk:
```{r echo = FALSE, results = "asis"}
# 6.243 COVID-19 overlijdens (+2) ( w: +19 ‚¨áÔ∏è )

dat.total <- dat.deaths %>%
  filter( municipality == "Netherlands" )
dat.total[dat.total$municipality=="Netherlands", "municipality"] <- "COVID-19 overlijdens"

print_municipality_data(dat.total, 'align-left', FALSE, TRUE)

rm(dat.total)
```

```{r echo = FALSE, results = "asis"}
int.count.municipality.today <- dat.deaths %>%
  filter(Municipality_code != "" & increase_1d > 0) %>%
  nrow()

int.count.municipality.week <- dat.deaths %>%
  filter(Municipality_code != "" & increase_7d > 0) %>%
  nrow()

dat.unknown <- dat.deaths %>%
  filter( municipality == "Unknown" )
unknown <- first(dat.unknown)

cat(sprintf("
%s / 355 gemeentes met nieuwe meldingen (w: %s )   
%s Gemeente Onbekend (%s)",
  format_custom_number(int.count.municipality.today),
  format_custom_number(int.count.municipality.week),
  format_custom_number(unknown$current),
  format_custom_number(unknown$increase_1d, TRUE)
))

rm(int.count.municipality.today, int.count.municipality.week, dat.unknown, unknown)
```

#### Hoogste sterfte per inwoner
```{r echo = FALSE, results = "asis"}
dat.deaths.today.top10 <- dat.deaths %>%
  arrange(desc(rel_increase_14d), current) %>%
  filter(increase_14d >= 2) %>%
  head(10) %>%
  transmute(
    municipality = sprintf('<span class="municipality">%s</span><hr/>', municipality),
    rel_increase_14d = format_custom_number(rel_increase_14d),
    per = "/ 100.000 / 14d"
  )

print_table(dat.deaths.today.top10, "llrl", "")
```

#### Absolute toenames van vandaag

```{r echo = FALSE, results = "asis"}
dat.deaths.today.highest <- dat.deaths %>%
  filter( 
    Municipality_code != "" & increase_1d != 0
  ) %>%
  arrange(desc(increase_1d), current)

print_municipality_data(dat.deaths.today.highest, "", FALSE, TRUE)

```

```{r echo=FALSE}
knitr::asis_output(htmltools::htmlPreserve("
  </header>
"))

```

### Alle gemeentes

```{r echo = FALSE, results = "asis"}

dat.deaths.today.all <- dat.deaths %>%
  filter(Municipality_code != "")

print_municipality_data(dat.deaths.today.all, "", FALSE, TRUE)

```

```{r echo=FALSE}
knitr::asis_output(htmltools::htmlPreserve("
</section>
"))

rm(list=ls())
```